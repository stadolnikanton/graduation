<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileCloud - Панель управления</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --light-bg: #f8f9fa;
            --sidebar-width: 250px;
        }

        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: #f5f7fb;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
        }

        .logo {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: white;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            border: none;
            padding: 10px 25px;
            font-weight: 600;
        }

        .file-icon {
            font-size: 3rem;
            color: #4361ee;
        }

        .file-card {
            cursor: pointer;
        }

        .file-card:hover {
            background-color: #f8f9fa;
        }

        .badge-access {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
        }

        #upload-progress {
            transition: all 0.3s;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                padding: 10px;
            }

            .main-content {
                margin-left: 70px;
            }

            .nav-link span {
                display: none;
            }

            .nav-link i {
                margin-right: 0;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">FileCloud</div>
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('files')">
                <i class="bi bi-folder"></i>
                <span>Мои файлы</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('upload')">
                <i class="bi bi-cloud-upload"></i>
                <span>Загрузить</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('shared')">
                <i class="bi bi-share"></i>
                <span>Поделиться</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('links')">
                <i class="bi bi-link-45deg"></i>
                <span>Ссылки</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('profile')">
                <i class="bi bi-person-circle"></i>
                <span>Профиль</span>
            </a>
            <div class="mt-auto">
                <button class="btn btn-outline-light w-100" onclick="logout()">
                    <i class="bi bi-box-arrow-left me-2"></i>
                    <span>Выйти</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Toast Notifications -->
        <div class="toast-container"></div>

        <!-- Files Section -->
        <div id="files-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-folder me-2"></i>Мои файлы</h2>
                <button class="btn btn-primary" onclick="showSection('upload')">
                    <i class="bi bi-plus-circle me-2"></i>Загрузить файл
                </button>
            </div>

            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Всего файлов</h5>
                        <h2 id="total-files">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card" style="background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);">
                        <h5>Мои файлы</h5>
                        <h2 id="owned-files">0</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card" style="background: linear-gradient(135deg, #7209b7 0%, #4361ee 100%);">
                        <h5>Доступ к файлам</h5>
                        <h2 id="shared-files">0</h2>
                    </div>
                </div>
            </div>

            <!-- Files Tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="showFilesTab('owned')">Мои файлы</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showFilesTab('shared')">Доступные мне</a>
                </li>
            </ul>

            <!-- Files List -->
            <div id="files-list">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="d-none">
            <h2 class="mb-4"><i class="bi bi-cloud-upload me-2"></i>Загрузка файлов</h2>

            <div class="card">
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label">Выберите файлы для загрузки</label>
                        <input type="file" class="form-control" id="file-input" multiple>
                        <div class="form-text">Максимальный размер файла: 100MB</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Прогресс загрузки</label>
                        <div class="progress" style="height: 25px;">
                            <div id="upload-progress" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="uploadFiles()">
                            <i class="bi bi-upload me-2"></i>Загрузить файлы
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showSection('files')">
                            <i class="bi bi-arrow-left me-2"></i>Назад
                        </button>
                    </div>

                    <!-- Upload Results -->
                    <div id="upload-results" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Share Section -->
        <div id="share-section" class="d-none">
            <h2 class="mb-4"><i class="bi bi-share me-2"></i>Поделиться файлом</h2>

            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Выберите файл</label>
                        <select class="form-select" id="share-file-select">
                            <option value="">Загрузка файлов...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ID пользователя для доступа</label>
                        <input type="number" class="form-control" id="share-user-id"
                            placeholder="Введите ID пользователя">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Уровень доступа</label>
                        <select class="form-select" id="share-access-level">
                            <option value="read">Только чтение</option>
                            <option value="write">Чтение и запись</option>
                            <option value="manage">Полный доступ</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="shareFile()">
                        <i class="bi bi-share-fill me-2"></i>Предоставить доступ
                    </button>
                </div>
            </div>
        </div>

        <!-- Links Section -->
        <div id="links-section" class="d-none">
            <h2 class="mb-4"><i class="bi bi-link-45deg me-2"></i>Публичные ссылки</h2>

            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Выберите файл для создания ссылки</label>
                        <select class="form-select" id="link-file-select">
                            <option value="">Загрузка файлов...</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Срок действия (часов)</label>
                            <input type="number" class="form-control" id="link-expires" value="24" min="1" max="720">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Лимит скачиваний</label>
                            <input type="number" class="form-control" id="link-max-downloads" value="1" min="1">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="createShareLink()">
                        <i class="bi bi-link me-2"></i>Создать ссылку
                    </button>

                    <!-- Active Links -->
                    <div class="mt-4" id="active-links"></div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="d-none">
            <h2 class="mb-4"><i class="bi bi-person-circle me-2"></i>Мой профиль</h2>

            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="user-avatar d-inline-flex mb-3">
                            <span id="user-initials">U</span>
                        </div>
                        <h4 id="user-name">Загрузка...</h4>
                        <p class="text-muted" id="user-email"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Текущая сессия</label>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Сессия действительна до обновления токена
                        </div>
                    </div>

                    <button class="btn btn-outline-danger w-100" onclick="logout()">
                        <i class="bi bi-box-arrow-left me-2"></i>Выйти из системы
                    </button>
                </div>
            </div>
        </div>

        <!-- File Actions Modal -->
        <div class="modal fade" id="fileModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="fileModalTitle">Действия с файлом</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="fileModalContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000';
        let currentUser = null;
        let filesData = null;
        let currentFileTab = 'owned';

        // Инициализация
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadFiles();
        });

        // Проверка аутентификации
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Not authenticated');
                }

                await loadUserProfile();
            } catch (error) {
                localStorage.removeItem('isAuthenticated');
                window.location.href = 'index.html';
            }
        }

        // Загрузка профиля пользователя
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-name').textContent = currentUser.name;
                    document.getElementById('user-email').textContent = currentUser.email;
                    document.getElementById('user-initials').textContent =
                        currentUser.name.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Загрузка файлов
        async function loadFiles() {
            try {
                const response = await fetch(`${API_BASE}/files/`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    filesData = await response.json();
                    updateStats();
                    renderFiles();
                }
            } catch (error) {
                showToast('Ошибка загрузки файлов', 'danger');
            }
        }

        // Обновление статистики
        function updateStats() {
            if (filesData) {
                document.getElementById('total-files').textContent =
                    filesData.counts.total;
                document.getElementById('owned-files').textContent =
                    filesData.counts.owned;
                document.getElementById('shared-files').textContent =
                    filesData.counts.shared;
            }
        }

        // Отображение файлов
        function renderFiles() {
            const filesList = document.getElementById('files-list');
            const files = currentFileTab === 'owned' ? filesData.files.owned : filesData.files.shared;

            if (files.length === 0) {
                filesList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-folder-x" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h5 class="mt-3 text-muted">Файлы не найдены</h5>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = files.map(file => `
                <div class="card file-card mb-3" onclick="openFileActions(${file.id})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <i class="bi bi-file-earmark file-icon"></i>
                            </div>
                            <div class="col">
                                <h5 class="mb-1">${file.original_filename}</h5>
                                <p class="text-muted mb-1">
                                    ${formatFileSize(file.size)} • 
                                    ${new Date(file.created_at).toLocaleDateString()}
                                </p>
                                ${file.shared_file ?
                    '<span class="badge bg-primary">Доступ</span>' :
                    '<span class="badge bg-success">Владелец</span>'
                }
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="event.stopPropagation(); downloadFile(${file.id})">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Переключение табов файлов
        function showFilesTab(tab) {
            currentFileTab = tab;
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            renderFiles();
        }

        // Переключение секций
        function showSection(sectionId) {
            // Скрыть все секции
            document.querySelectorAll('.main-content > div[id$="section"]').forEach(div => {
                div.classList.add('d-none');
            });

            // Показать выбранную секцию
            document.getElementById(`${sectionId}-section`).classList.remove('d-none');

            // Обновить активную ссылку в сайдбаре
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Загрузить данные для секции
            if (sectionId === 'files') {
                loadFiles();
            } else if (sectionId === 'shared') {
                loadShareData();
            } else if (sectionId === 'links') {
                loadLinksData();
            } else if (sectionId === 'profile') {
                loadUserProfile();
            }
        }

        // Загрузка данных для раздела "Поделиться"
        async function loadShareData() {
            const select = document.getElementById('share-file-select');
            select.innerHTML = '<option value="">Загрузка файлов...</option>';

            try {
                const response = await fetch(`${API_BASE}/files/`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    select.innerHTML = data.files.owned.map(file =>
                        `<option value="${file.id}">${file.original_filename}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Failed to load files for sharing:', error);
            }
        }

        // Предоставить доступ к файлу
        async function shareFile() {
            const fileId = document.getElementById('share-file-select').value;
            const userId = document.getElementById('share-user-id').value;
            const accessLevel = document.getElementById('share-access-level').value;

            if (!fileId || !userId) {
                showToast('Заполните все поля', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/files/${fileId}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        access_level: accessLevel
                    })
                });

                if (response.ok) {
                    showToast('Доступ успешно предоставлен', 'success');
                    document.getElementById('share-user-id').value = '';
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Ошибка', 'danger');
                }
            } catch (error) {
                showToast('Ошибка соединения', 'danger');
            }
        }

        // Загрузка данных для раздела ссылок
        async function loadLinksData() {
            const select = document.getElementById('link-file-select');
            select.innerHTML = '<option value="">Загрузка файлов...</option>';

            try {
                const response = await fetch(`${API_BASE}/files/`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    select.innerHTML = data.files.owned.map(file =>
                        `<option value="${file.id}">${file.original_filename}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('Failed to load files for links:', error);
            }
        }

        // Создание публичной ссылки
        async function createShareLink() {
            const fileId = document.getElementById('link-file-select').value;
            const expiresHours = document.getElementById('link-expires').value;
            const maxDownloads = document.getElementById('link-max-downloads').value;

            if (!fileId) {
                showToast('Выберите файл', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('expires_hours', expiresHours);
            formData.append('max_downloads', maxDownloads);

            try {
                const response = await fetch(`${API_BASE}/share/${fileId}/`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast('Ссылка создана успешно!', 'success');

                    // Показать ссылку
                    const activeLinks = document.getElementById('active-links');
                    activeLinks.innerHTML = `
                        <div class="alert alert-success">
                            <h6>Новая ссылка:</h6>
                            <p class="mb-2">
                                <a href="${API_BASE}/share/${data.token}" target="_blank">
                                    ${API_BASE}/share/${data.token}
                                </a>
                            </p>
                            <small class="text-muted">
                                Действует до: ${new Date(data.expires_at).toLocaleString()}
                            </small>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Ошибка создания ссылки', 'danger');
                }
            } catch (error) {
                showToast('Ошибка соединения', 'danger');
            }
        }

        // Загрузка файлов на сервер
        async function uploadFiles() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;

            if (files.length === 0) {
                showToast('Выберите файлы для загрузки', 'warning');
                return;
            }

            const progressBar = document.getElementById('upload-progress');
            const resultsDiv = document.getElementById('upload-results');
            progressBar.style.width = '0%';
            resultsDiv.innerHTML = '';

            // Проверка размера каждого файла
            for (let file of files) {
                if (file.size > 100 * 1024 * 1024) {
                    showToast(`Файл ${file.name} превышает 100MB`, 'danger');
                    return;
                }
            }

            // Загрузка одного файла
            if (files.length === 1) {
                const formData = new FormData();
                formData.append('file', files[0]);

                try {
                    const response = await fetch(`${API_BASE}/files/upload/`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    progressBar.style.width = '100%';

                    if (response.ok) {
                        const result = await response.json();
                        showToast('Файл успешно загружен!', 'success');
                        resultsDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h6>${result.filename}</h6>
                                <p class="mb-0">Размер: ${formatFileSize(result.size)}</p>
                            </div>
                        `;
                        await loadFiles();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Ошибка загрузки', 'danger');
                    }
                } catch (error) {
                    showToast('Ошибка соединения', 'danger');
                }
            }
            // Загрузка нескольких файлов
            else {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }

                try {
                    const response = await fetch(`${API_BASE}/files/upload/multiple`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    progressBar.style.width = '100%';

                    if (response.ok) {
                        const result = await response.json();
                        showToast(`Загружено ${result.successful} из ${result.total_files} файлов`, 'success');

                        resultsDiv.innerHTML = result.files.map(file => `
                            <div class="alert alert-${file.status === 'success' ? 'success' : 'danger'}">
                                <h6>${file.filename}</h6>
                                ${file.status === 'success' ?
                                `<p class="mb-0">Размер: ${formatFileSize(file.size)}</p>` :
                                `<p class="mb-0">Ошибка: ${file.error}</p>`
                            }
                            </div>
                        `).join('');

                        await loadFiles();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Ошибка загрузки', 'danger');
                    }
                } catch (error) {
                    showToast('Ошибка соединения', 'danger');
                }
            }

            // Сбросить поле выбора файлов
            fileInput.value = '';
        }

        // Скачивание файла
        function downloadFile(fileId) {
            window.open(`${API_BASE}/files/${fileId}/download`, '_blank');
        }

        // Открытие модального окна с действиями файла
        function openFileActions(fileId) {
            const file = findFileById(fileId);
            if (!file) return;

            const modal = new bootstrap.Modal(document.getElementById('fileModal'));
            document.getElementById('fileModalTitle').textContent = file.original_filename;

            const isOwner = file.is_owner;

            let content = `
                <div class="mb-3">
                    <p><strong>Имя файла:</strong> ${file.original_filename}</p>
                    <p><strong>Размер:</strong> ${formatFileSize(file.size)}</p>
                    <p><strong>Дата создания:</strong> ${new Date(file.created_at).toLocaleString()}</p>
                    <p><strong>Статус:</strong> ${isOwner ? 'Владелец' : 'Доступ предоставлен'}</p>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="downloadFile(${fileId})">
                        <i class="bi bi-download me-2"></i>Скачать файл
                    </button>
            `;

            if (isOwner) {
                content += `
                    <button class="btn btn-outline-primary" onclick="showSection('shared')">
                        <i class="bi bi-share me-2"></i>Поделиться
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteFile(${fileId})">
                        <i class="bi bi-trash me-2"></i>Удалить файл
                    </button>
                `;
            }

            content += `</div>`;

            document.getElementById('fileModalContent').innerHTML = content;
            modal.show();
        }

        // Удаление файла
        async function deleteFile(fileId) {
            if (!confirm('Вы уверены, что хотите удалить этот файл?')) return;

            try {
                const response = await fetch(`${API_BASE}/files/${fileId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    showToast('Файл успешно удален', 'success');
                    await loadFiles();
                    bootstrap.Modal.getInstance(document.getElementById('fileModal')).hide();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Ошибка удаления', 'danger');
                }
            } catch (error) {
                showToast('Ошибка соединения', 'danger');
            }
        }

        // Поиск файла по ID
        function findFileById(fileId) {
            const allFiles = [...filesData.files.owned, ...filesData.files.shared];
            return allFiles.find(file => file.id === fileId);
        }

        // Выход из системы
        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                localStorage.removeItem('isAuthenticated');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Показ уведомлений
        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('id', toastId);

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                            data-bs-dismiss="toast"></button>
                </div>
            `;

            container.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });

            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Форматирование размера файла
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Автоматическое обновление токена
        setInterval(async () => {
            try {
                await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.log('Token refresh failed');
            }
        }, 25 * 60 * 1000); // Каждые 25 минут
    </script>
</body>

</html>
